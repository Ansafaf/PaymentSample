<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway | Safe and Secure</title>
    <!-- jQuery and jQuery Confirm -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 1230px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: #fff;
            padding: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 600;
            color: #e60000;
        }

        .secure-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e8f5e9;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
        }

        /* Payment Info Box */
        .payment-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .payment-info h2 {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .payment-details .label {
            font-size: 13px;
            opacity: 0.9;
        }

        .payment-details .value {
            font-size: 24px;
            font-weight: 700;
        }

        /* Main Content */
        .main-wrapper {
            max-width: 1024px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .payment-wrapper {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tabs-nav::-webkit-scrollbar {
            height: 4px;
        }

        .tabs-nav::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }

        .tab-item {
            flex: 1;
            min-width: 140px;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-item:hover {
            background: #fff;
        }

        .tab-item.active {
            background: #fff;
            border-bottom-color: #2874f0;
        }

        .tab-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            display: block;
            opacity: 0.6;
        }

        .tab-item.active .tab-icon {
            opacity: 1;
        }

        .tab-label {
            font-size: 14px;
            font-weight: 500;
            text-transform: capitalize;
            color: #666;
        }

        .tab-item.active .tab-label {
            color: #2874f0;
            font-weight: 600;
        }

        .lightning-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ffd700;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* UPI Section */
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .upi-app-section {
            text-align: center;
            padding: 40px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: #fff;
        }

        .upi-app-section h3 {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .upi-app-section p {
            margin-bottom: 20px;
            opacity: 0.95;
            font-size: 15px;
        }

        .btn-primary {
            background: #fff;
            color: #667eea;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: #e9ecef;
        }

        .divider span {
            background: #fff;
            padding: 0 20px;
            position: relative;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2874f0;
            box-shadow: 0 0 0 3px rgba(40, 116, 240, 0.1);
        }

        .form-control.error {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .security-note {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 13px;
            color: #2e7d32;
        }

        .btn-submit {
            background: #2874f0;
            color: #fff;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            background: #1a5fd4;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 116, 240, 0.3);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Card Section */
        .card-form {
            max-width: 500px;
        }

        .card-number-wrapper {
            position: relative;
        }

        .card-type-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Netbanking Section */
        .bank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .bank-option {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bank-option:hover {
            border-color: #2874f0;
            background: #f8f9fa;
        }

        .bank-option.selected {
            border-color: #2874f0;
            background: #e3f2fd;
        }

        .bank-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 12px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
        }

        .bank-name {
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }

        /* Wallets Section */
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .wallet-option {
            padding: 24px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-option:hover {
            border-color: #2874f0;
            background: #f8f9fa;
        }

        .wallet-option.selected {
            border-color: #2874f0;
            background: #e3f2fd;
        }

        .wallet-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 12px;
            background: #f5f5f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-wrapper {
                flex-direction: column;
                text-align: center;
            }

            .main-wrapper {
                margin: 20px auto;
            }

            .tab-content {
                padding: 20px;
            }

            .tabs-nav {
                flex-wrap: nowrap;
            }

            .tab-item {
                min-width: 100px;
                padding: 16px 8px;
            }

            .tab-icon {
                width: 28px;
                height: 28px;
            }

            .tab-label {
                font-size: 12px;
            }

            .upi-app-section {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .bank-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .wallet-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .payment-details {
                flex-direction: column;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }

            .section-title {
                font-size: 18px;
            }

            .tab-content {
                padding: 16px;
            }

            .bank-grid,
            .wallet-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-wrapper">
                <div class="logo-wrapper">
                    <div class="logo-text">Vi</div>
                    <span style="color: #666; font-size: 14px;">payments</span>
                </div>
                <div class="secure-badge">
                    <span>üîí</span>
                    <span>100% Secure</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-wrapper">
        <!-- Payment Info -->
        <div class="payment-info">
            <h2>Payment Details</h2>
            <div class="payment-details">
                <div>
                    <div class="label">Amount to Pay</div>
                    <div class="value">‚Çπ<%= typeof amount !=='undefined' ? amount : '0.00' %>
                    </div>
                </div>
            </div>
        </div>

        <div class="payment-wrapper">
            <!-- Tabs Navigation -->
            <nav class="tabs-nav">
                <div class="tab-item active" data-tab="upi">
                    <div style="position: relative;">
                        <div class="tab-icon">üí≥</div>
                        <div class="lightning-badge">‚ö° Fast</div>
                    </div>
                    <div class="tab-label">UPI</div>
                </div>
                <div class="tab-item" data-tab="card">
                    <div class="tab-icon">üí≥</div>
                    <div class="tab-label">Credit/Debit Card</div>
                </div>
                <div class="tab-item" data-tab="netbanking">
                    <div class="tab-icon">üè¶</div>
                    <div class="tab-label">Net Banking</div>
                </div>
                <div class="tab-item" data-tab="wallet">
                    <div class="tab-icon">üëõ</div>
                    <div class="tab-label">Wallets</div>
                </div>
            </nav>

            <!-- UPI Tab Content -->
            <div class="tab-content active" data-content="upi">
                <div class="upi-app-section">
                    <h3>Pay with UPI</h3>
                    <p>Click the button below to pay using any UPI app</p>
                    <a href="<%= upiMeUrl %>" class="btn-primary" style="text-decoration: none; display: inline-block;">
                        Pay via UPI
                    </a>

                    <p style="margin-top: 20px; font-size: 14px; opacity: 0.9;">
                        Supports PhonePe, Google Pay, Paytm, BHIM and all UPI apps
                    </p>
                    <div style="display:none;">
                        <!-- Triggers for the script -->
                        <button id="upiwc-cancel-payment">Cancel</button>
                        <button class="upiwc-return-link">Return</button>
                    </div>
                </div>

                <div class="security-note" style="margin-top: 30px;">
                    <span>üîí</span>
                    <span>Your transaction is 100% secure and encrypted</span>
                </div>
            </div>

            <!-- Card Tab Content -->
            <div class="tab-content" data-content="card">
                <h3 class="section-title">Credit/Debit Card</h3>
                <form class="card-form" id="cardForm">
                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <div class="card-number-wrapper">
                            <input type="text" class="form-control" placeholder="1234 5678 9012 3456" disabled />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Name on Card</label>
                        <input type="text" class="form-control" placeholder="John Doe" disabled />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Expiry (MM/YY)</label>
                            <input type="text" class="form-control" placeholder="MM/YY" disabled />
                        </div>
                        <div class="form-group">
                            <label class="form-label">CVV</label>
                            <input type="password" class="form-control" placeholder="123" disabled />
                        </div>
                    </div>

                    <div class="security-note">
                        <span>üîí</span>
                        <span>Secure encrypted payment</span>
                    </div>

                    <button type="button" class="btn-submit" disabled>Pay ‚Çπ<%= typeof amount !=='undefined' ? amount
                            : '0.00' %>
                    </button>
                    <p style="margin-top: 10px; color: #666; font-size: 14px; text-align: center;">Currently
                        unavailable. Please use UPI.</p>
                </form>
            </div>


            <!-- Net Banking Tab Content -->
            <div class="tab-content" data-content="netbanking">
                <h3 class="section-title">Select Your Bank</h3>
                <p style="color: #666; margin-bottom: 20px;">Choose your bank to proceed with payment</p>

                <form id="bankForm">
                    <div class="bank-grid" id="bankGrid">
                        <!-- Banks preserved for UI selection feeling -->
                        <div class="bank-option" onclick="selectItem(this, 'bank')">
                            <div class="bank-logo">HDFC</div>
                            <div class="bank-name">HDFC Bank</div>
                        </div>
                        <div class="bank-option" onclick="selectItem(this, 'bank')">
                            <div class="bank-logo">ICICI</div>
                            <div class="bank-name">ICICI Bank</div>
                        </div>
                        <div class="bank-option" onclick="selectItem(this, 'bank')">
                            <div class="bank-logo">SBI</div>
                            <div class="bank-name">State Bank</div>
                        </div>
                        <!-- ... other banks ... -->
                    </div>

                    <button type="button" class="btn-submit" id="bankPayBtn" style="margin-top: 30px;"
                        onclick="startPayment('netbanking')">
                        Pay via Netbanking
                    </button>
                </form>
            </div>

            <!-- Wallets Tab Content -->
            <div class="tab-content" data-content="wallet">
                <h3 class="section-title">Digital Wallets</h3>
                <p style="color: #666; margin-bottom: 20px;">Select your preferred wallet to complete the payment</p>

                <form id="walletForm">
                    <div class="wallet-grid" id="walletGrid">
                        <div class="wallet-option" onclick="selectItem(this, 'wallet')">
                            <div class="wallet-icon" style="background: #00BAF2; color: white;">P</div>
                            <div class="bank-name">Paytm</div>
                        </div>
                        <!-- ... other wallets ... -->
                    </div>

                    <button type="button" class="btn-submit" id="walletPayBtn" style="margin-top: 30px;"
                        onclick="startPayment('wallet')">
                        Pay with Wallet
                    </button>
                    ```html
                </form>
            </div>
        </div>
    </main>


    <!-- Templates for jQuery Confirm Modal -->
    <div style="display: none;">
        <div class="upiwc-modal-header">Complete Payment</div>
        <div class="upiwc-modal-content">
            <!-- STEP 1: Apps & QR -->
            <div class="upiwc-payment-container">
                <div class="upiwc-payment-info" style="text-align: center; margin-bottom: 20px;">
                    <p>Scan the QR code or select an app to pay</p>
                    <div class="upiwc-payment-upi-id"
                        style="font-weight: bold; font-size: 18px; margin: 10px 0; cursor: pointer; color: #2874f0;"
                        title="Click to Copy">
                        <%= upiwcData.payee_vpa %> üìã
                    </div>
                </div>

                <div class="upiwc-payment-qr-code" id="upiwc-payment-qr-code"
                    style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <!-- QR Code Generated Here -->
                </div>

                <div class="upiwc-payment-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="upiwc-payment-btn btn-primary" data-type="gpay"
                        style="width: 100%; margin: 5px 0; background: white; color: #333; border: 1px solid #ddd;">
                        Google Pay
                    </button>
                    <button class="upiwc-payment-btn btn-primary" data-type="phonepe"
                        style="width: 100%; margin: 5px 0; background: white; color: #333; border: 1px solid #ddd;">
                        PhonePe
                    </button>
                    <button class="upiwc-payment-btn btn-primary" data-type="paytm"
                        style="width: 100%; margin: 5px 0; background: white; color: #333; border: 1px solid #ddd;">
                        Paytm
                    </button>
                    <button class="upiwc-payment-btn btn-primary" data-type="bhim"
                        style="width: 100%; margin: 5px 0; background: white; color: #333; border: 1px solid #ddd;">
                        BHIM / UPI

                    </button>

                </div>

                <div class="upiwc-payment-intent-error error-message" style="text-align: center; margin-top: 10px;">
                </div>
            </div>

            <!-- STEP 2: Confirmation / UTR -->
            <div class="upiwc-payment-confirm" style="display: none;">
                <p>Please enter the Transaction ID (UTR) to confirm your payment.</p>
                <form id="upiwc-payment-confirm-form">
                    <div class="form-group">
                        <label class="form-label">Transaction ID (12 Digits)</label>
                        <input type="text" class="form-control" id="upiwc-payment-transaction-number"
                            name="upiwc_transaction_id" placeholder="e.g. 123456789012" maxlength="12"
                            onkeypress="return upiwcIsNumber(event)">
                    </div>

                    <!-- Optional Image Upload if configured -->
                    <div class="form-group" style="display: none;"> <!-- Hidden by default as per config -->
                        <label class="form-label">Upload Screenshot</label>
                        <input type="file" class="form-control" id="upiwc-payment-file" name="upiwc_transaction_image"
                            accept="image/*">
                    </div>

                    <div class="upiwc-payment-error error-message"></div>
                </form>
            </div>
        </div>

        <!-- Loading State -->
        <div id="upiwc-processing" style="display: none;">Processing...</div>
        <div class="upiwc-waiting-text" style="display: none;"></div>
    </div>

    <!-- Pass Data to JS -->
    <script>
        var upiwcData = "<% JSON.stringify(upiwcData || {}) %>";

        // Ensure order_amount is string
        if (upiwcData.order_amount) {
            upiwcData.order_amount = upiwcData.order_amount.toString();
        }

        // Add required nonce if missing
        if (upiwcData) {
            upiwcData.nonce = upiwcData.nonce || 'xyz';
        }
    </script>



    <script>
        // User Provided Functionality
        (function ($) {
            "use strict";

            if (typeof upiwcData === 'undefined') {
                return false;
            }

            // Robust URI component encoding
            let pa = upiwcData.payee_vpa;
            let pn = encodeURIComponent(upiwcData.payee_name);
            let am = upiwcData.order_amount;
            let tr = upiwcData.order_key ? upiwcData.order_key.replace('wc_order_', '') : '';
            let tn = encodeURIComponent(upiwcData.payee_name + ' OrderId:' + upiwcData.order_number);

            // Construct Link
            let paymentLink = `pay?pa=${pa}&pn=${pn}&am=${am}&tr=${tr}&tn=${tn}&cu=INR`;

            // Only add Merchant Code if it exists and is not '0000'
            if (upiwcData.mc_code && upiwcData.mc_code !== '0000') {
                paymentLink += `&mc=${upiwcData.mc_code}`;
            }

            // Only add mode/orgid if specifically required/configured
            // paymentLink += `&mode=01`; // Often causes issues if not a valid merchant
            // paymentLink += `&orgid=000000`; // Often causes issues

            // Note: We don't need global replace(/\s/g,'') if we encode components properly.
            // But to be 100% safe to 'upi://' prefix, we ensure it's a valid URI.
            // paymentLink = encodeURI(paymentLink); // Not needed if components are encoded

            $('body').on('contextmenu', '.upiwc-payment-qr-code img', function (e) {
                return false;
            });

            $('body').on('click', '#upiwc-cancel-payment', function (e) {
                e.preventDefault();
                if (upiwcData.cancel_url) window.location = upiwcData.cancel_url;
            });

            $('body').on('click', '.upiwc-return-link', function (e) {
                e.preventDefault();
                if (upiwcData.payment_url) window.location = upiwcData.payment_url;
            });

            $('body').on('click', '#upiwc-confirm-payment', function (e) {
                e.preventDefault();

                let amountContent = '<span class="payment-amount">‚Çπ ' + upiwcData.order_amount + '</span>';
                if (upiwcData.payer_vpa != '' && upiwcData.payer_vpa) {
                    amountContent += '<span class="upi-id">' + upiwcData.payer_vpa + '</span>';
                }
                let paymentModal = $.confirm({
                    title: $('body').find('.upiwc-modal-header').html(),
                    content: $('body').find('.upiwc-modal-content').html(),
                    useBootstrap: false,
                    animation: 'scale',
                    boxWidth: '90%', // Mobile responsive
                    maxWidth: '400px', // Max width
                    draggable: false,
                    offsetBottom: 0,
                    offsetTop: 0,
                    closeIcon: true,
                    bgOpacity: .8,
                    lazyOpen: true,
                    theme: upiwcData.theme || 'modern',
                    onOpenBefore: function () {
                        // Fix for responsive width
                        this.$el.find('.jconfirm-box').css({ 'max-width': '400px', 'width': '100%' });
                        this.$el.addClass('upiwc-payment-modal');

                        $(document).trigger('upiwcOnOpenBefore', [this]);
                    },
                    onContentReady: function () {
                        $(document).trigger('upiwcBeforeContentReady', [this]);

                        let self = this;
                        let timeoutIntent, timeoutCopy;

                        self.$content.find('.upiwc-payment-upi-id').on('click', function (e) {
                            e.preventDefault();
                            clearTimeout(timeoutCopy);

                            navigator.clipboard.writeText(upiwcData.payee_vpa).then(function () {
                                console.log('Copying to clipboard was successful!');
                            }, function (err) {
                                console.error('Could not copy text: ', err);
                            });

                            let el = $(this)
                            let originalText = el.text();
                            el.text('Copied!');
                            timeoutCopy = setTimeout(function () {
                                el.html(upiwcData.payee_vpa + ' üìã'); // Restore with icon
                            }, 1000);
                        });

                        self.$content.find('#upiwc-payment-transaction-number').on('input', function (e) {
                            self.$content.find('.upiwc-payment-error').hide();
                        });

                        self.$content.find('#upiwc-payment-file').on('change', function (e) {
                            self.$content.find('.upiwc-payment-error').hide();
                        });

                        // Generate QR inside the modal
                        if (self.$content.find('#upiwc-payment-qr-code').length) {
                            self.$content.find('#upiwc-payment-qr-code').empty(); // Clear previous
                            new QRCode(self.$content.find('#upiwc-payment-qr-code')[0], {
                                text: 'upi://' + paymentLink,
                                width: 200,
                                height: 200,
                                correctLevel: QRCode.CorrectLevel.H,
                                quietZone: 8
                            });
                        }

                        // We can get src after generation
                        // let qrCodeSrc = self.$content.find( '#upiwc-payment-qr-code img' ).attr( 'src' );

                        self.$content.find('.upiwc-payment-btn').on('click', function (e) {
                            e.preventDefault();
                            clearTimeout(timeoutIntent);
                            self.$content.find('.upiwc-payment-intent-error').hide();

                            let type = $(this).data('type');
                            let intentLink = upiwcIntent(paymentLink, type);
                            console.log("Opening Intent:", intentLink);

                            // Try to open
                            window.location.href = intentLink;

                            timeoutIntent = setTimeout(function () {
                                // Just show a helper message, cannot detect close reliably
                                self.$content.find('.upiwc-payment-intent-error').text('If app did not open, scan QR code.').show();
                            }, 2500);
                        });

                        let btnShowInterval = parseInt(upiwcData.btn_show_interval);
                        if (btnShowInterval && btnShowInterval >= 1000) {
                            if (upiwcData.btn_timer == 1) {
                                upiwcStartTimer(btnShowInterval / 1000, document.querySelector('.btn.upiwc-next'));
                            }
                            setTimeout(function () {
                                self.buttons.nextStep.setText('Proceed to Next');
                                self.buttons.nextStep.enable();
                            }, btnShowInterval);
                        } else {
                            self.buttons.nextStep.setText('I have Paid');
                            self.buttons.nextStep.enable();
                        }

                        $(document).trigger('upiwcAfterContentReady', [this]);
                    },
                    onClose: function () {
                        $('#upiwc-processing').hide();
                        $('#upiwc-confirm-payment, #upiwc-cancel-payment, .upiwc-return-link').show();
                        $('.upiwc-waiting-text').text('Please click the Pay Now button below to complete the payment against this order.');

                        $(document).trigger('upiwcOnClose', [this]);
                    },
                    onAction: function (btnName) {
                        $(document).trigger('upiwcOnAction', [this, btnName]);
                    },
                    buttons: {
                        amount: {
                            text: amountContent,
                            btnClass: 'upiwc-amount',
                            action: function () {
                                return false;
                            }
                        },
                        nextStep: {
                            text: 'Waiting...',
                            btnClass: 'upiwc-next btn-primary',
                            isDisabled: true, // Enabled after timeout or immediately
                            action: function () {
                                $(document).trigger('upiwcBeforeNextStepAction', [this]);

                                let self = this;
                                self.$content.find('.upiwc-payment-confirm').show();
                                self.$content.find('.upiwc-payment-info, .upiwc-payment-qr-code, .upiwc-payment-actions, .upiwc-payment-container').hide(); // removed upiwc-show class check
                                self.$closeIcon.hide();

                                self.buttons.amount.hide();
                                self.buttons.nextStep.hide();
                                self.buttons.back.show();
                                self.buttons.confirm.show();

                                $(document).trigger('upiwcAfterNextStepAction', [this]);
                                return false;
                            }
                        },
                        back: {
                            text: 'Back',
                            isHidden: true,
                            btnClass: 'upiwc-back btn-secondary',
                            action: function () {
                                $(document).trigger('upiwcBeforeBackAction', [this]);

                                let self = this;
                                self.$content.find('.upiwc-payment-confirm').hide();
                                self.$content.find('.upiwc-payment-info, .upiwc-payment-qr-code, .upiwc-payment-actions, .upiwc-payment-container').show();
                                self.buttons.amount.show();
                                self.buttons.nextStep.show();
                                self.buttons.back.hide();
                                self.buttons.confirm.hide();
                                self.$closeIcon.show();

                                $(document).trigger('upiwcAfterBackAction', [this]);
                                return false;
                            }
                        },
                        confirm: {
                            text: 'Confirm',
                            btnClass: 'upiwc-confirm btn-submit',
                            isHidden: true,
                            action: function () {
                                $(document).trigger('upiwcBeforeConfirmAction', [this]);

                                let self = this;
                                let utr_field = self.$content.find('#upiwc-payment-transaction-number');
                                let utr_image = self.$content.find('#upiwc-payment-file');

                                if (utr_field.length > 0) {
                                    let tran_id = utr_field.val();

                                    if (tran_id != '' && tran_id.length != 12) {
                                        self.$content.find('.upiwc-payment-error').text('Transaction ID should be of 12 digits!').show();
                                        return false;
                                    }

                                    if (upiwcData.transaction_id === 'show_require' && tran_id == '') {
                                        self.$content.find('.upiwc-payment-error').text('Transaction ID is required!').show();
                                        return false;
                                    }
                                }

                                if (utr_image.length > 0 && upiwcData.transaction_image === 'show_require') {
                                    var fileInput = utr_image[0];

                                    if (!fileInput.files.length) {
                                        self.$content.find('.upiwc-payment-error').text('File is required!').show();
                                        return false;
                                    }
                                }

                                utr_field.attr('readonly', 'readonly');
                                self.buttons.confirm.disable();
                                self.buttons.back.disable();
                                self.buttons.confirm.setText('Processing...');

                                let upiForm = self.$content.find('#upiwc-payment-confirm-form');
                                // Prevent actual form submit, use fetch/ajax
                                // upiForm.attr( 'method', 'POST' );
                                // upiForm.attr( 'action', upiwcData.callback_url );
                                // upiForm.submit();

                                // AJAX Submission
                                const txnId = utr_field.val();
                                fetch(upiwcData.callback_url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        orderId: upiwcData.order_key,
                                        transactionId: txnId,
                                        amount: upiwcData.order_amount
                                    })
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.success) {
                                            window.location.href = '/payment/success/' + upiwcData.order_key; // Or appropriate success page
                                        } else {
                                            self.$content.find('.upiwc-payment-error').text(data.message || 'Verification failed').show();
                                            utr_field.removeAttr('readonly');
                                            self.buttons.confirm.enable();
                                            self.buttons.back.enable();
                                            self.buttons.confirm.setText('Confirm');
                                        }
                                    })
                                    .catch(err => {
                                        console.error(err);
                                        self.$content.find('.upiwc-payment-error').text('Network Error').show();
                                        utr_field.removeAttr('readonly');
                                        self.buttons.confirm.enable();
                                        self.buttons.back.enable();
                                        self.buttons.confirm.setText('Confirm');
                                    });

                                $(document).trigger('upiwcAfterConfirmAction', [this]);
                                return false;
                            }
                        }
                    }
                });
                paymentModal.open();

                $('#upiwc-processing').show();
                // $( '#upiwc-confirm-payment, #upiwc-cancel-payment, .upiwc-return-link' ).hide();
                $('.upiwc-waiting-text').text('Please wait and don\'t press back or refresh this page while we are processing your payment...');
            });

            // Not needed here as we init inside modal
            // if ( $( '#upiwc-payment-qr-code' ).length ) { ... }

        })(jQuery);

        function upiwcIntent(link, type) {
            let prefix = 'upi://';
            switch (type) {
                case 'gpay':
                    prefix = 'gpay://upi/';
                    break;
                case 'phonepe':
                    prefix = 'phonepe://';
                    break;
                case 'paytm':
                    prefix = 'paytmmp://';
                    break;
                case 'bhim':
                    prefix = 'upi://';
                    break;
                default:
                    prefix = 'upi://';
            }

            return prefix + link;
        }

        function upiwcIsNumber(evt) {
            evt = (evt) ? evt : window.event;
            let charCode = (evt.which) ? evt.which : evt.keyCode;
            if (8 != charCode && 0 != charCode && charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        function upiwcStartTimer(duration, display) {
            let start = Date.now(),
                diff,
                minutes,
                seconds,
                timerInterval;

            function timer() {
                diff = duration - (((Date.now() - start) / 1000) | 0);

                minutes = (diff / 60) | 0;
                seconds = (diff % 60) | 0;

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = 'Waiting... (' + minutes + ":" + seconds + ')';

                if (diff <= 0) {
                    start = Date.now() + 1000;
                }
            };

            clearTimeout(timerInterval)

            timer();

            timerInterval = setInterval(timer, 1000);
            setTimeout(function () {
                clearTimeout(timerInterval)
            }, duration * 1000);
        }
    </script>
</body>

</html>